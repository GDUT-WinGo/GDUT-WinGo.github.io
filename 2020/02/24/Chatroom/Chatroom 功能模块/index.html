<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Chatroom 各功能模块的实现 | Wingo&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Chatroom">
    <meta name="description" content="Chatroom 各功能模块的分析与实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="Chatroom 各功能模块的实现">
<meta property="og:url" content="http://yoursite.com/2020/02/24/Chatroom/Chatroom%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="Wingo&#39;s Blog">
<meta property="og:description" content="Chatroom 各功能模块的分析与实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CLayout01.png">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CUserInfoInit.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CSingleSend.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest02.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest03.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest01.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest04.PNG">
<meta property="article:published_time" content="2020-02-24T02:20:02.000Z">
<meta property="article:modified_time" content="2020-04-19T06:24:52.203Z">
<meta property="article:author" content="Wingo">
<meta property="article:tag" content="Chatroom">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Wingo</h5>
          <a href="mailto:1318263468@qq.com" title="1318263468@qq.com" class="mail">1318263468@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Chatroom 各功能模块的实现</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Chatroom 各功能模块的实现</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-02-24T02:20:02.000Z" itemprop="datePublished" class="page-time">
  2020-02-24
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Project/">Project</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用户登录"><span class="post-toc-number">1.</span> <span class="post-toc-text">用户登录</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#初始化用户信息"><span class="post-toc-number">2.</span> <span class="post-toc-text">初始化用户信息</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#用户拦截认证"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">用户拦截认证</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#PO-amp-VO"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">PO &amp; VO</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#页面布局"><span class="post-toc-number">3.</span> <span class="post-toc-text">页面布局</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用户单聊"><span class="post-toc-number">4.</span> <span class="post-toc-text">用户单聊</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#单聊流程"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">单聊流程</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#监听绑定"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">监听绑定</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#WebSocket-处理"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">WebSocket 处理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#发送按钮"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">发送按钮</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#消息框处理"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">消息框处理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#好友列表处理"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">好友列表处理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#服务器处理"><span class="post-toc-number">4.7.</span> <span class="post-toc-text">服务器处理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#测试"><span class="post-toc-number">4.8.</span> <span class="post-toc-text">测试</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#群组聊天"><span class="post-toc-number">5.</span> <span class="post-toc-text">群组聊天</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#发送表情"><span class="post-toc-number">6.</span> <span class="post-toc-text">发送表情</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#发送文件"><span class="post-toc-number">7.</span> <span class="post-toc-text">发送文件</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Chatroom/Chatroom 功能模块"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Chatroom 各功能模块的实现</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-02-24 10:20:02" datetime="2020-02-24T02:20:02.000Z"  itemprop="datePublished">2020-02-24</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Project/">Project</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>Chatroom 各功能模块的分析与实现。</p>
<a id="more"></a>

<p>数据库结构</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG" alt=""></p>
<p><strong>基于 Spring 注解式开发</strong></p>
<p>前后端分离，返回 Json 的视图对象类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseJson</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer SUCCESS_STATUS = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer ERROR_STATUS = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUCCESS_MSG = <span class="string">"一切正常"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        setStatus(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">(HttpStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        setStatus(status.value());</span><br><span class="line">        setMsg(status.getReasonPhrase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, SUCCESS_MSG);</span><br><span class="line">        put(<span class="string">"status"</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">success</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        put(<span class="string">"status"</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">error</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        put(<span class="string">"status"</span>, ERROR_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setData</span><span class="params">(String key, Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        HashMap&lt;String, Object&gt; data = (HashMap&lt;String, Object&gt;) get(<span class="string">"data"</span>);</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">            put(<span class="string">"data"</span>, data);</span><br><span class="line">        &#125;</span><br><span class="line">        data.put(key, obj);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setStatus</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"status"</span>, status);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setValue</span><span class="params">(String key, Object val)</span> </span>&#123;</span><br><span class="line">        put(key, val);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回JSON字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject.toJSONString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用来存放 Netty WebSocket 连接信息的常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个 userId 对应一个 Session</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TOKEN = <span class="string">"userId"</span>;</span><br><span class="line">	<span class="comment">// 用于保存 Http 升级 WebSocket 后的握手实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, WebSocketServerHandshaker&gt; webSocketHandshakerMap =</span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;String, WebSocketServerHandshaker&gt;();</span><br><span class="line">	<span class="comment">// 用于保存已登录的用户的通道信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, ChannelHandlerContext&gt; onlineUserMap = </span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;String, ChannelHandlerContext&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h3><p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG" alt=""></p>
<p>User 👉 实体类，与数据库表 user 向对应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略了 Getter Setter toString 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserDao、UserMapper👉 通过用户输入的用户名到数据库中找到此用户的用户信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">User <span class="title">getByUsername</span><span class="params">(String username)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getByUsername"</span> <span class="attr">resultType</span>=<span class="string">"com.wingo.model.po.User"</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 具体的sql --&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    	user_id, username, password</span><br><span class="line">    FROM</span><br><span class="line">    	user</span><br><span class="line">    WHERE</span><br><span class="line">    	username = #&#123;username&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SecurityService、SecurityServiceImpl 👉 实现登录的业务逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">login</span><span class="params">(String username, String password, HttpSession session)</span> </span>&#123;</span><br><span class="line">    User user = userDao.getByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"不存在该用户名"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!user.getPassword().equals(password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"密码不正确"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将已登录的用户的 userId 保存在 Session 中</span></span><br><span class="line">    session.setAttribute(Constant.USER_TOKEN, user.getUserId());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SecurityController 👉 URL映射以及前后端数据交互</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"login"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">login</span><span class="params">(HttpSession session, @RequestParam String username, @RequestParam String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> securityService.login(username, password, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户点击登录按钮后，发送 Ajax 请求进行用户验证，验证通过后跳转到 chatroom 页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type : <span class="string">'POST'</span>,</span><br><span class="line">        url : <span class="string">'login'</span>,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        data : &#123;</span><br><span class="line">            username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">            password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">false</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="built_in">window</span>.location.href=<span class="string">"chatroom"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化用户信息"><a href="#初始化用户信息" class="headerlink" title="初始化用户信息"></a>初始化用户信息</h3><p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG" alt=""></p>
<h4 id="用户拦截认证"><a href="#用户拦截认证" class="headerlink" title="用户拦截认证"></a>用户拦截认证</h4><p>UserAuthInteceptor 👉 检测用户是否登录并设置资源访问权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAuthInteceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        Object userToken = session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (userToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.sendRedirect(<span class="string">"login"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 允许所有资源都可以访问资源</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">// 表示是否可以将对请求的响应暴露给页面</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>,<span class="string">"true"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置 Spring MVC 对 chatoom 页面的访问请求进行拦截认证</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用户认证拦截器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/chatroom/**"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.wingo.web.interceptor.UserAuthInteceptor"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="PO-amp-VO"><a href="#PO-amp-VO" class="headerlink" title="PO &amp; VO"></a>PO &amp; VO</h4><p>在返回给用户的信息中，除了用户的个人信息，还需要用户的好友列表信息以及群聊列表信息。创建一个 VO 类用于保存前端所需要的所有信息。</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG" alt=""></p>
<p>UserInfo 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; friendList; <span class="comment">// 好友列表信息</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Chatgroup&gt; groupList; <span class="comment">// 群聊信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器方法便于实例化</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Chatgroup 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// group 为 MySQL 的关键字，不可使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chatgroup</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GroupInfo 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; members;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器方法便于实例化</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ChatroomController 👉 通过 userId 获取用户的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/get_userinfo"</span>, method = RequestMethod.POST) </span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">getUserInfo</span><span class="params">(HttpSession session)</span> </span>&#123;</span><br><span class="line">    Object userId = session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">    System.out.println(<span class="string">"Session 中的 userId = "</span> + userId);</span><br><span class="line">    <span class="keyword">return</span> userService.getByUserId(String.valueOf(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserChatRelationDao userChatRelationDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GroupDao groupDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">getByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        User user = userDao.getByUserId(userId);</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo(</span><br><span class="line">            user.getUserId(),</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getPassword(),</span><br><span class="line">            user.getAvatarUrl()</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// friendList 构造</span></span><br><span class="line">        List&lt;String&gt; friendsId = userChatRelationDao.getUserFriendsIdByUserId(userId);</span><br><span class="line">        List&lt;User&gt; friends = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String friendId : friendsId)&#123;</span><br><span class="line">            User friend = userDao.getByUserId(friendId);</span><br><span class="line">            friends.add(friend);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// groupList 构造</span></span><br><span class="line">        List&lt;String&gt; groupsId = userChatRelationDao.getGroupsIdByUserId(userId);</span><br><span class="line">        List&lt;Chatgroup&gt; groups = <span class="keyword">new</span> ArrayList&lt;Chatgroup&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupId : groupsId)&#123;</span><br><span class="line">            Chatgroup group = groupDao.getByGroupId(groupId);</span><br><span class="line">            groups.add(group);</span><br><span class="line">        &#125;</span><br><span class="line">        userInfo.setGroupList(groups);</span><br><span class="line">        userInfo.setFriendList(friends);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"userInfo"</span>, userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 Swagger 模拟请求取得返回的 Json 数据。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"一切正常"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"userInfo"</span>: &#123;</span><br><span class="line">            <span class="attr">"userId"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"username"</span>: <span class="string">"test1"</span>,</span><br><span class="line">            <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span>,</span><br><span class="line">            <span class="attr">"friendList"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test2"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">4</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test3"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test4"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"groupList"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"groupId"</span>: <span class="number">1000</span>,</span><br><span class="line">                    <span class="attr">"groupName"</span>: <span class="string">"Group1"</span>,</span><br><span class="line">                    <span class="attr">"groupAvatarUrl"</span>: <span class="string">"static/img/avatar/Group01.jpg"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户信息初始化完成。</p>
<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><p>粗略版</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CLayout01.png" alt=""></p>
<h3 id="用户单聊"><a href="#用户单聊" class="headerlink" title="用户单聊"></a>用户单聊</h3><p>前端页面在取得后台所返回的 Json 信息之后，根据信息初始化用户的聊天页面。</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CUserInfoInit.PNG" alt=""></p>
<blockquote>
<p>此程序不将聊天信息保存到数据库中，而是保存在前端的聊天页面用 Javascript 所自定义的一个数据结构里，一个<code>SentMessageMap(key, new Array())</code>。用户进行用户信息的初始化时要将此用户信息中的 groupId 以及 userId 作为键初始化这个聊天信息的 Map，以便后面进行聊天信息的保存。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setUserInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type : <span class="string">'POST'</span>,</span><br><span class="line">        url : <span class="string">'chatroom/get_userinfo'</span>,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">true</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"获取用户信息..."</span>);</span><br><span class="line">            <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// 自定义的数据结构，用于保存聊天信息进行回显</span></span><br><span class="line">                sentMessageMap = <span class="keyword">new</span> SentMessageMap();</span><br><span class="line">                <span class="comment">// 获取用户信息</span></span><br><span class="line">                <span class="keyword">var</span> userInfo = data.data.userInfo;</span><br><span class="line">                userId = userInfo.userId;</span><br><span class="line">                $(<span class="string">"#username"</span>).html(userInfo.username);</span><br><span class="line">                $(<span class="string">"#avatarUrl"</span>).attr(<span class="string">"src"</span>, userInfo.avatarUrl);</span><br><span class="line">                <span class="keyword">var</span> groupListHTML = <span class="string">""</span>;</span><br><span class="line">                <span class="comment">// 获取用户的群组信息</span></span><br><span class="line">                <span class="keyword">var</span> groupList = userInfo.groupList;</span><br><span class="line">                <span class="comment">// 初始化群聊框列表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; groupList.length; i++) &#123;</span><br><span class="line">                    <span class="comment">// 添加 Key</span></span><br><span class="line">                    sentMessageMap.put(groupList[i].groupId, <span class="keyword">new</span> <span class="built_in">Array</span>());</span><br><span class="line">                    groupListHTML +=</span><br><span class="line">                        <span class="string">'&lt;li&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;div class="liLeft"&gt;&lt;img src="'</span> + groupList[i].groupAvatarUrl + <span class="string">'"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;div class="liRight"&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;span class="hidden-groupId"&gt;'</span> + groupList[i].groupId + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="intername"&gt;'</span> + groupList[i].groupName + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="infor"&gt;&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加群聊框列表</span></span><br><span class="line">                $(<span class="string">'.conLeft ul'</span>).append(groupListHTML);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> friendListHTML = <span class="string">""</span>;</span><br><span class="line">                <span class="comment">// 获取用户好友信息</span></span><br><span class="line">                <span class="keyword">var</span> friendList = userInfo.friendList;</span><br><span class="line">                <span class="comment">// 初始化好友框列表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; friendList.length; i++) &#123;</span><br><span class="line">                    <span class="comment">// 添加 Key</span></span><br><span class="line">                    sentMessageMap.put(friendList[i].userId, <span class="keyword">new</span> <span class="built_in">Array</span>());</span><br><span class="line">                    friendListHTML +=</span><br><span class="line">                        <span class="string">'&lt;li&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;div class="liLeft"&gt;&lt;img src="'</span> + friendList[i].avatarUrl + <span class="string">'"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;div class="liRight"&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;span class="hidden-userId"&gt;'</span> + friendList[i].userId + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="intername"&gt;'</span> + friendList[i].username + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="infor"&gt;&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加好友列表</span></span><br><span class="line">                $(<span class="string">'.conLeft ul'</span>).append(friendListHTML);</span><br><span class="line">                <span class="comment">// 绑定好友框点击事件：显示右侧消息框</span></span><br><span class="line">                $(<span class="string">'.conLeft ul li'</span>).on(<span class="string">'click'</span>, friendLiClickEvent);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="单聊流程"><a href="#单聊流程" class="headerlink" title="单聊流程"></a>单聊流程</h4><p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CSingleSend.PNG" alt=""></p>
<h4 id="监听绑定"><a href="#监听绑定" class="headerlink" title="监听绑定"></a>监听绑定</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.WebSocket)&#123;  </span><br><span class="line">    <span class="built_in">window</span>.WebSocket = <span class="built_in">window</span>.MozWebSocket;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket)&#123;  </span><br><span class="line">    socket = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3333"</span>);  </span><br><span class="line">    socket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">var</span> json = <span class="built_in">JSON</span>.parse(event.data);    </span><br><span class="line">        <span class="keyword">if</span> (json.status == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> type = json.data.type;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"收到一条新信息，类型为："</span> + type);</span><br><span class="line">            <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"REGISTER"</span>:</span><br><span class="line">                    ws.registerReceive();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"SINGLE_SENDING"</span>:</span><br><span class="line">                    ws.singleReceive(json.data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"不正确的类型！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(json.msg);</span><br><span class="line">            <span class="built_in">console</span>.log(json.msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接成功1秒后，将用户信息注册到服务器在线用户表</span></span><br><span class="line">    socket.onopen = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123; </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"WebSocket已成功连接！"</span>);  </span><br><span class="line">        ws.register();</span><br><span class="line">    &#125;, <span class="number">1000</span>)  </span><br><span class="line"></span><br><span class="line">    socket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;  </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"WebSocket已关闭..."</span>);  </span><br><span class="line">    &#125;;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    alert(<span class="string">"您的浏览器不支持WebSocket！"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="WebSocket-处理"><a href="#WebSocket-处理" class="headerlink" title="WebSocket 处理"></a>WebSocket 处理</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = &#123;</span><br><span class="line">    register: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">window</span>.WebSocket) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">"userId"</span> : userId,</span><br><span class="line">                <span class="string">"type"</span> : <span class="string">"REGISTER"</span></span><br><span class="line">            &#125;;</span><br><span class="line">            socket.send(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"Websocket连接没有开启！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    singleSend: <span class="function"><span class="keyword">function</span>(<span class="params">fromUserId, toUserId, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">window</span>.WebSocket) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">"fromUserId"</span> : fromUserId,</span><br><span class="line">                <span class="string">"toUserId"</span> : toUserId,</span><br><span class="line">                <span class="string">"content"</span> : content,</span><br><span class="line">                <span class="string">"type"</span> : <span class="string">"SINGLE_SENDING"</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 将信息发送给客户端的 WebSocketServerhandler 进行处理</span></span><br><span class="line">            socket.send(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"Websocket连接没有开启！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    registerReceive: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"userId为 "</span> + userId + <span class="string">" 的用户登记到在线用户表成功！"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    singleReceive: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取、构造参数</span></span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">        <span class="keyword">var</span> content = data.content;</span><br><span class="line">        <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">        <span class="keyword">var</span> $receiveLi;</span><br><span class="line">        <span class="comment">// 为设置消息提醒以及获取头像取得元素</span></span><br><span class="line">        $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">                fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                    .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">                $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> answer=<span class="string">''</span>;</span><br><span class="line">        answer += <span class="string">'&lt;li&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="answers"&gt;'</span>+ content +<span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息框处理 放入暂存区，若用户正处于与新发消息用户的聊天窗口则回显（利用暂存区计算高度）</span></span><br><span class="line">        processMsgBox.receiveSingleMsg(answer, fromUserId);</span><br><span class="line">        <span class="comment">// 好友列表处理 1.设置红色提醒标志 2.设置部分新消息提醒 3.置顶新消息</span></span><br><span class="line">        processFriendList.receiving(content, $receiveLi);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="发送按钮"><a href="#发送按钮" class="headerlink" title="发送按钮"></a>发送按钮</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.sendBtn'</span>).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">'#toUserId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">'#toGroupId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> news = $(<span class="string">'#dope'</span>).val();</span><br><span class="line">    <span class="keyword">if</span> (toUserId == <span class="string">''</span> &amp;&amp; toGroupId == <span class="string">''</span>) &#123;</span><br><span class="line">        alert(<span class="string">"请选择对话方"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(news == <span class="string">''</span>)&#123;</span><br><span class="line">        alert(<span class="string">'消息不能为空'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">            ws.singleSend(fromUserId, toUserId, news);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 群发</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $(<span class="string">'#dope'</span>).val(<span class="string">''</span>);			</span><br><span class="line">        <span class="keyword">var</span> avatarUrl = $(<span class="string">'#avatarUrl'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">        <span class="keyword">var</span> msg = <span class="string">''</span>;</span><br><span class="line">        msg += <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">            <span class="string">'&lt;div class="news"&gt;'</span> + news + <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="nesHead"&gt;&lt;img src="'</span> + avatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息框处理：</span></span><br><span class="line">        processMsgBox.sendMsg(msg, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 好友列表处理：</span></span><br><span class="line">        <span class="keyword">var</span> $sendLi = $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>);</span><br><span class="line">        processFriendList.sending(news, $sendLi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="消息框处理"><a href="#消息框处理" class="headerlink" title="消息框处理"></a>消息框处理</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sendMsg: <span class="function"><span class="keyword">function</span>(<span class="params">msg, toUserId, toGroupId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 把内容添加到消息框</span></span><br><span class="line">    $(<span class="string">'.newsList'</span>).append(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 手动计算、调整回显消息的宽度</span></span><br><span class="line">    <span class="keyword">var</span> $newsDiv = $(<span class="string">'.newsList li'</span>).last().children(<span class="string">"div"</span>).first();</span><br><span class="line">    <span class="keyword">var</span> fixWidth = <span class="number">300</span>; <span class="comment">// 自定义的消息框本身的最长宽度</span></span><br><span class="line">    <span class="keyword">var</span> maxWidth = <span class="number">493</span>; <span class="comment">// 消息框所在行 div 的满宽度（不包含头像框的宽度部分）</span></span><br><span class="line">    <span class="keyword">var</span> minMarginLeftWidth = <span class="number">224</span>; <span class="comment">// 按理说应该是 maxwidth - fixWidth，这里出现了点问题</span></span><br><span class="line">    <span class="keyword">var</span> marginLeftWidth; <span class="comment">// 要计算消息框的margin-left宽度</span></span><br><span class="line">    <span class="keyword">if</span> ($newsDiv.actual(<span class="string">'width'</span>) &lt; fixWidth) &#123;</span><br><span class="line">        marginLeftWidth = maxWidth - $newsDiv.actual(<span class="string">'width'</span>);</span><br><span class="line">        $newsDiv.css(<span class="string">"margin-left"</span>, marginLeftWidth + <span class="string">"px"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $newsDiv.css(<span class="string">"width"</span>, fixWidth + <span class="string">"px"</span>)</span><br><span class="line">            .css(<span class="string">"margin-left"</span>, minMarginLeftWidth + <span class="string">"px"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 把 调整后的消息html标签字符串 添加到已发送用户消息表</span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 得到数组添加新消息 以 outerHTML 的形式</span></span><br><span class="line">        <span class="comment">// last() 得到匹配元素的最后一个</span></span><br><span class="line">        sentMessageMap.get(toUserId).push($(<span class="string">'.newsList li'</span>).last().prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentMessageMap.get(toGroupId).push($(<span class="string">'.newsList li'</span>).last().prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 滚动条往底部移</span></span><br><span class="line">    $(<span class="string">'.RightCont'</span>).scrollTop($(<span class="string">'.RightCont'</span>)[<span class="number">0</span>].scrollHeight );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="好友列表处理"><a href="#好友列表处理" class="headerlink" title="好友列表处理"></a>好友列表处理</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sending: <span class="function"><span class="keyword">function</span>(<span class="params">content, $sendLi</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置部分新消息提醒</span></span><br><span class="line">    <span class="keyword">if</span> (content.length &gt; <span class="number">8</span>) &#123;</span><br><span class="line">        content = content.substring(<span class="number">0</span>, <span class="number">8</span>) + <span class="string">"..."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>).children(<span class="string">'.liRight'</span>).children(<span class="string">'.infor'</span>).text(content);</span><br><span class="line">    <span class="comment">// 如果存在新消息提醒徽章，则去除徽章</span></span><br><span class="line">    <span class="keyword">if</span> ($sendLi.find(<span class="string">'.layui-badge'</span>).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $sendLi.find(<span class="string">'.layui-badge'</span>).remove();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//$('.conLeft ul').prepend('&lt;li class="bg"&gt;' + $sendLi.html() + '&lt;/li&gt;');</span></span><br><span class="line">    <span class="comment">// 好友框新消息置顶</span></span><br><span class="line">    $(<span class="string">'.conLeft ul'</span>).prepend($sendLi.prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    $sendLi.remove();</span><br><span class="line">    $(<span class="string">'.conLeft ul li'</span>).first().on(<span class="string">'click'</span>, friendLiClickEvent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器处理"><a href="#服务器处理" class="headerlink" title="服务器处理"></a>服务器处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">singleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toUserId = (String)param.get(<span class="string">"toUserId"</span>);</span><br><span class="line">    String content = (String)param.get(<span class="string">"content"</span>);</span><br><span class="line">    <span class="comment">// 取得接收者的通道</span></span><br><span class="line">    ChannelHandlerContext toUserCtx = Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">"userId为 &#123;0&#125; 的用户没有登录！"</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"content"</span>, content)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        <span class="comment">// 发送消息给接收者的通道，浏览器 socket 监听处理</span></span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest02.PNG" alt=""></p>
<p>通过控制台调试可以取得 sentMessageMap 中保存了与 userId=2 的用户的聊天信息数组。</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest03.PNG" alt=""></p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest01.PNG" alt=""></p>
<p>通过控制台调试可以取得 sentMessageMap 中保存了与 userId=1 的用户的聊天信息数组。</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest04.PNG" alt=""></p>
<h3 id="群组聊天"><a href="#群组聊天" class="headerlink" title="群组聊天"></a>群组聊天</h3><p>群组聊天的流程与用户单聊流程基本相似，只是在给接收者的通道发送消息时需要通过群组信息取得群组里的成员的信息，并获取成员的所有通道进行消息的遍发送。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">groupSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toGroupId = (String)param.get(<span class="string">"toGroupId"</span>);</span><br><span class="line">    String content = (String)param.get(<span class="string">"content"</span>);</span><br><span class="line">    Chatgroup chatgroup = groupDao.getByGroupId(toGroupId);</span><br><span class="line">    <span class="keyword">if</span> (chatgroup == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().error(<span class="string">"该群id不存在"</span>).toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;String&gt; groupUsersId = userChatRelationDao.getUsersIdByGroupId(toGroupId);</span><br><span class="line">        List&lt;User&gt; groupUser = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupUserId : groupUsersId)&#123;</span><br><span class="line">            groupUser.add(userDao.getByUserId(groupUserId));</span><br><span class="line">        &#125;</span><br><span class="line">        GroupInfo groupInfo = <span class="keyword">new</span> GroupInfo(</span><br><span class="line">            chatgroup.getGroupId(),</span><br><span class="line">            chatgroup.getGroupName(),</span><br><span class="line">            chatgroup.getGroupAvatarUrl(),</span><br><span class="line">            groupUser</span><br><span class="line">        );</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"content"</span>, content)</span><br><span class="line">            .setData(<span class="string">"toGroupId"</span>, toGroupId)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.GROUP_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        groupInfo.getMembers()</span><br><span class="line">            .forEach(member -&gt; &#123;</span><br><span class="line">                ChannelHandlerContext toCtx = Constant.onlineUserMap.get(String.valueOf(member.getUserId()));</span><br><span class="line">                <span class="keyword">if</span> (toCtx != <span class="keyword">null</span> &amp;&amp; !String.valueOf(member.getUserId()).equals(fromUserId)) &#123;</span><br><span class="line">                    sendMessage(toCtx, responseJson);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收消息者则根据 groupId 来显示接收到的消息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">groupReceive: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取、构造参数</span></span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">    <span class="keyword">var</span> content = data.content;</span><br><span class="line">    <span class="keyword">var</span> toGroupId = data.toGroupId;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">            <span class="comment">/* $receiveLi = $(this).parent(".liRight").parent("li"); */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-groupId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 群组聊天框</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == toGroupId) &#123;</span><br><span class="line">            $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> answer=<span class="string">''</span>;</span><br><span class="line">    answer += <span class="string">'&lt;li&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answers"&gt;'</span>+ content +<span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息框处理   </span></span><br><span class="line">    processMsgBox.receiveGroupMsg(answer, toGroupId);</span><br><span class="line">    <span class="comment">// 好友列表处理</span></span><br><span class="line">    processFriendList.receiving(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="发送表情"><a href="#发送表情" class="headerlink" title="发送表情"></a>发送表情</h3><p>表情的发送的底层原理和发送文字是一样的，只是发送表情的话，发送内容是一串静态资源的 URI。</p>
<p>表情模块绑定的监听事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.ExP'</span>).on(<span class="string">'mouseenter'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">'.emjon'</span>).show();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">'.emjon'</span>).on(<span class="string">'mouseleave'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">'.emjon'</span>).hide();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="发送文件"><a href="#发送文件" class="headerlink" title="发送文件"></a>发送文件</h3><p>文件的上传使用的是 commons-fileupload 工具类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 文件上传 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>文件上传的模态框表格：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"col-sm-3 control-label"</span>&gt;</span>选择文件<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-9"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">class</span>=<span class="string">"col-sm-9 myfile"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"help-block"</span>&gt;</span>注意：文件大小不超过30M，有效期为7天<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Bootstrap 的文件上传控件 bootstrap-fileinput 的使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">".myfile"</span>).fileinput(&#123;</span><br><span class="line">    uploadUrl:<span class="string">"chatroom/upload"</span>,</span><br><span class="line">    uploadAsync : <span class="literal">true</span>, <span class="comment">// 默认异步上传</span></span><br><span class="line">    showUpload : <span class="literal">true</span>, <span class="comment">// 是否显示上传按钮</span></span><br><span class="line">    showRemove : <span class="literal">false</span>, <span class="comment">// 显示移除按钮</span></span><br><span class="line">    showCaption : <span class="literal">false</span>, <span class="comment">// 是否显示标题</span></span><br><span class="line">    showPreview : <span class="literal">true</span>, <span class="comment">// 是否显示预览，默认为 true</span></span><br><span class="line">    dropZoneTitle: <span class="string">"请通过拖拽图片文件放到这里"</span>,</span><br><span class="line">    dropZoneEnabled : <span class="literal">false</span>, <span class="comment">// 是否显示拖拽区域，默认不写为 true，但是会占用很大区域</span></span><br><span class="line">    maxFileSize: <span class="number">30720</span>, <span class="comment">// 单位为 kb，如果为 0 表示不限制文件大小</span></span><br><span class="line">    maxFileCount : <span class="number">1</span>,  <span class="comment">// 表示允许同时上传的最大文件个数</span></span><br><span class="line">    enctype : <span class="string">'multipart/form-data'</span>,</span><br><span class="line">    validateInitialCount : <span class="literal">true</span>,</span><br><span class="line">    previewFileIcon : <span class="string">"&lt;i class='glyphicon glyphicon-file'&gt;&lt;/i&gt;"</span>,</span><br><span class="line">    msgFilesTooMany : <span class="string">"选择上传的文件数量(&#123;n&#125;) 超过允许的最大数值&#123;m&#125;！"</span>,</span><br><span class="line">    language : <span class="string">'zh'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 异步上传返回文件上传错误结果处理</span></span><br><span class="line">$(<span class="string">'.myfile'</span>).on(<span class="string">'fileerror'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, msg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fileerror"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 异步上传返回结果处理</span></span><br><span class="line">$(<span class="string">".myfile"</span>).on(<span class="string">"fileuploaded"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 上传成功1.5秒后自动关闭上传模态框</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fileuploaded"</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'#upload-cancel'</span>).trigger(<span class="string">'click'</span>);</span><br><span class="line">        $(<span class="string">'.fileinput-remove'</span>).trigger(<span class="string">'click'</span>);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取、设置参数</span></span><br><span class="line">    <span class="keyword">var</span> returnData = data.response.data;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = returnData.originalFilename;</span><br><span class="line">    <span class="keyword">var</span> fileSize = returnData.fileSize;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = returnData.fileUrl;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">"[文件]"</span>;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> avatarUrl = $(<span class="string">'#avatarUrl'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">    <span class="keyword">var</span> $sendLi = $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>);</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">'#toUserId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">'#toGroupId'</span>).val();</span><br><span class="line">    <span class="comment">// 拼接发送者对话框的消息</span></span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;div class="send-file-shown"&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;a href="'</span> + fileUrl + <span class="string">'" class="media-left"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;i class="glyphicon glyphicon-file" style="font-size:28pt;"&gt;&lt;/i&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/a&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media-body"&gt; '</span> +</span><br><span class="line">        <span class="string">'&lt;h5 class="media-heading"&gt;'</span> + originalFilename + <span class="string">'&lt;/h5&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;span&gt;'</span>+ fileSize + <span class="string">'&lt;/span&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="nesHead"&gt;&lt;img src="'</span> + avatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 发送信息到服务器        </span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">        ws.fileMsgSingleSend(fromUserId, toUserId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ws.fileMsgGroupSend(fromUserId, toGroupId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 消息框处理： </span></span><br><span class="line">    processMsgBox.sendFileMsg(fileHtml, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 好友列表处理</span></span><br><span class="line">    processFriendList.sending(content, $sendLi);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//上传前</span></span><br><span class="line">$(<span class="string">'.myfile'</span>).on(<span class="string">'filepreupload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"filepreupload"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>文件上传的控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/upload"</span>, method = POST)</span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestParam(value = <span class="string">"file"</span>, required = <span class="keyword">true</span>)</span> MultipartFile file, HttpServletRequest request) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fileUploadService.upload(file, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件上传的业务逻辑处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadServiceImpl</span> <span class="keyword">implements</span> <span class="title">FileUploadService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 项目的打包目录，本项目打包在根目录下</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String SERVER_URL_PREFIX = <span class="string">"http://localhost:8080/"</span>;</span><br><span class="line">    <span class="comment">// 保存上传文件的文件夹名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FILE_STORE_PATH = <span class="string">"UploadFile"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">upload</span><span class="params">(MultipartFile file, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 重命名文件，防止重名</span></span><br><span class="line">        String filename = getRandomUUID();</span><br><span class="line">        String suffix = <span class="string">""</span>;</span><br><span class="line">        String originalFilename = file.getOriginalFilename();</span><br><span class="line">        String fileSize = FileUtils.getFormatSize(file.getSize());</span><br><span class="line">        <span class="comment">// 截取文件的后缀名</span></span><br><span class="line">        <span class="keyword">if</span> (originalFilename.contains(<span class="string">"."</span>)) &#123;</span><br><span class="line">            suffix = originalFilename.substring(originalFilename.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        filename = filename + suffix;</span><br><span class="line">        <span class="comment">// getRealPath(“/”) 获取实际路径,“/”指代项目根目录,所以代码返回的是项目在容器中的实际发布运行的根路径</span></span><br><span class="line">        String prefix = request.getSession().getServletContext().getRealPath(<span class="string">"/"</span>) + FILE_STORE_PATH;</span><br><span class="line">        System.out.println(<span class="string">"存储路径为:"</span> + prefix + <span class="string">"\\"</span> + filename);</span><br><span class="line">        Path filePath = Paths.get(prefix, filename);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.copy(file.getInputStream(), filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"文件上传发生错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"originalFilename"</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">"fileSize"</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">"fileUrl"</span>, SERVER_URL_PREFIX + FILE_STORE_PATH + <span class="string">"\\"</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getRandomUUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSoclet 处理文件发送方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FileMsgSingleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toUserId = (String)param.get(<span class="string">"toUserId"</span>);</span><br><span class="line">    String originalFilename = (String)param.get(<span class="string">"originalFilename"</span>);</span><br><span class="line">    String fileSize = (String)param.get(<span class="string">"fileSize"</span>);</span><br><span class="line">    String fileUrl = (String)param.get(<span class="string">"fileUrl"</span>);</span><br><span class="line">    ChannelHandlerContext toUserCtx = Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">"userId为 &#123;0&#125; 的用户没有登录！"</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"originalFilename"</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">"fileSize"</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">"fileUrl"</span>, fileUrl)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.FILE_MSG_SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 群发文件则与群组聊天类似，取群组中的用户的通道遍历发送文件信息</span></span><br></pre></td></tr></table></figure>

<p>接收者对话框接收文件消息的拼接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">fileMsgSingleRecieve: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取、构造参数</span></span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = data.originalFilename;</span><br><span class="line">    <span class="keyword">var</span> fileSize = data.fileSize;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = data.fileUrl;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">"[文件]"</span>;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">            $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;div class="receive-file-shown"&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="media-body"&gt; '</span> +</span><br><span class="line">        <span class="string">'&lt;h5 class="media-heading"&gt;'</span> + originalFilename + <span class="string">'&lt;/h5&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;span&gt;'</span>+ fileSize + <span class="string">'&lt;/span&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;a href="'</span> + fileUrl + <span class="string">'" class="media-right"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;i class="glyphicon glyphicon-file" style="font-size:28pt;"&gt;&lt;/i&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/a&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息框处理     </span></span><br><span class="line">    processMsgBox.receiveSingleMsg(fileHtml, fromUserId);</span><br><span class="line">    <span class="comment">// 好友列表处理</span></span><br><span class="line">    processFriendList.receiving(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>


        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-04-19T06:24:52.203Z" itemprop="dateUpdated">2020-04-19 14:24:52</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/avatar.jpg" alt="Wingo">
            Wingo
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chatroom/" rel="tag">Chatroom</a></li></ul>


            


        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/02/25/English/CET6%20%E9%98%85%E8%AF%BB%E7%9C%9F%E9%A2%98/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">CET6 阅读真题</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/02/22/Chatroom/Chatroom%20Mybatis/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Chatroom Mybatis</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
            <span>得失从缘，心无增减</span>
        </p>
    </div> 
    <div class="bottom">
        <p><span>Wingo &copy; 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: false, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










</body>
</html>
