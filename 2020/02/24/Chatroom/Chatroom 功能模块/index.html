<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Chatroom å„åŠŸèƒ½æ¨¡å—çš„å®ç° | Wingo&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Chatroom">
    <meta name="description" content="Chatroom å„åŠŸèƒ½æ¨¡å—çš„åˆ†æä¸å®ç°ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Chatroom å„åŠŸèƒ½æ¨¡å—çš„å®ç°">
<meta property="og:url" content="http://yoursite.com/2020/02/24/Chatroom/Chatroom%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="Wingo&#39;s Blog">
<meta property="og:description" content="Chatroom å„åŠŸèƒ½æ¨¡å—çš„åˆ†æä¸å®ç°ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CLayout01.png">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CUserInfoInit.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CSingleSend.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest02.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest03.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest01.PNG">
<meta property="og:image" content="d:%5CImage%5C2020%5C03%5CChatroom%5CTest04.PNG">
<meta property="article:published_time" content="2020-02-24T02:20:02.000Z">
<meta property="article:modified_time" content="2020-04-19T06:24:52.203Z">
<meta property="article:author" content="Wingo">
<meta property="article:tag" content="Chatroom">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Wingo</h5>
          <a href="mailto:1318263468@qq.com" title="1318263468@qq.com" class="mail">1318263468@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Chatroom å„åŠŸèƒ½æ¨¡å—çš„å®ç°</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="è¾“å…¥æ„Ÿå…´è¶£çš„å…³é”®å­—">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Chatroom å„åŠŸèƒ½æ¨¡å—çš„å®ç°</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-02-24T02:20:02.000Z" itemprop="datePublished" class="page-time">
  2020-02-24
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Project/">Project</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç”¨æˆ·ç™»å½•"><span class="post-toc-number">1.</span> <span class="post-toc-text">ç”¨æˆ·ç™»å½•</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯"><span class="post-toc-number">2.</span> <span class="post-toc-text">åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç”¨æˆ·æ‹¦æˆªè®¤è¯"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">ç”¨æˆ·æ‹¦æˆªè®¤è¯</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#PO-amp-VO"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">PO &amp; VO</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é¡µé¢å¸ƒå±€"><span class="post-toc-number">3.</span> <span class="post-toc-text">é¡µé¢å¸ƒå±€</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç”¨æˆ·å•èŠ"><span class="post-toc-number">4.</span> <span class="post-toc-text">ç”¨æˆ·å•èŠ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å•èŠæµç¨‹"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">å•èŠæµç¨‹</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç›‘å¬ç»‘å®š"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">ç›‘å¬ç»‘å®š</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#WebSocket-å¤„ç†"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">WebSocket å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å‘é€æŒ‰é’®"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">å‘é€æŒ‰é’®</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#æ¶ˆæ¯æ¡†å¤„ç†"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">æ¶ˆæ¯æ¡†å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å¥½å‹åˆ—è¡¨å¤„ç†"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">å¥½å‹åˆ—è¡¨å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#æœåŠ¡å™¨å¤„ç†"><span class="post-toc-number">4.7.</span> <span class="post-toc-text">æœåŠ¡å™¨å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#æµ‹è¯•"><span class="post-toc-number">4.8.</span> <span class="post-toc-text">æµ‹è¯•</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç¾¤ç»„èŠå¤©"><span class="post-toc-number">5.</span> <span class="post-toc-text">ç¾¤ç»„èŠå¤©</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å‘é€è¡¨æƒ…"><span class="post-toc-number">6.</span> <span class="post-toc-text">å‘é€è¡¨æƒ…</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å‘é€æ–‡ä»¶"><span class="post-toc-number">7.</span> <span class="post-toc-text">å‘é€æ–‡ä»¶</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Chatroom/Chatroom åŠŸèƒ½æ¨¡å—"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Chatroom å„åŠŸèƒ½æ¨¡å—çš„å®ç°</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-02-24 10:20:02" datetime="2020-02-24T02:20:02.000Z"  itemprop="datePublished">2020-02-24</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Project/">Project</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>Chatroom å„åŠŸèƒ½æ¨¡å—çš„åˆ†æä¸å®ç°ã€‚</p>
<a id="more"></a>

<p>æ•°æ®åº“ç»“æ„</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG" alt=""></p>
<p><strong>åŸºäº Spring æ³¨è§£å¼å¼€å‘</strong></p>
<p>å‰åç«¯åˆ†ç¦»ï¼Œè¿”å› Json çš„è§†å›¾å¯¹è±¡ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseJson</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer SUCCESS_STATUS = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer ERROR_STATUS = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUCCESS_MSG = <span class="string">"ä¸€åˆ‡æ­£å¸¸"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        setStatus(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseJson</span><span class="params">(HttpStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        setStatus(status.value());</span><br><span class="line">        setMsg(status.getReasonPhrase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, SUCCESS_MSG);</span><br><span class="line">        put(<span class="string">"status"</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">success</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        put(<span class="string">"status"</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">error</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        put(<span class="string">"status"</span>, ERROR_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setData</span><span class="params">(String key, Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        HashMap&lt;String, Object&gt; data = (HashMap&lt;String, Object&gt;) get(<span class="string">"data"</span>);</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">            put(<span class="string">"data"</span>, data);</span><br><span class="line">        &#125;</span><br><span class="line">        data.put(key, obj);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setStatus</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"status"</span>, status);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">setValue</span><span class="params">(String key, Object val)</span> </span>&#123;</span><br><span class="line">        put(key, val);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›JSONå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject.toJSONString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æ¥å­˜æ”¾ Netty WebSocket è¿æ¥ä¿¡æ¯çš„å¸¸é‡ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ä¸ª userId å¯¹åº”ä¸€ä¸ª Session</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TOKEN = <span class="string">"userId"</span>;</span><br><span class="line">	<span class="comment">// ç”¨äºä¿å­˜ Http å‡çº§ WebSocket åçš„æ¡æ‰‹å®ä¾‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, WebSocketServerHandshaker&gt; webSocketHandshakerMap =</span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;String, WebSocketServerHandshaker&gt;();</span><br><span class="line">	<span class="comment">// ç”¨äºä¿å­˜å·²ç™»å½•çš„ç”¨æˆ·çš„é€šé“ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, ChannelHandlerContext&gt; onlineUserMap = </span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;String, ChannelHandlerContext&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç”¨æˆ·ç™»å½•"><a href="#ç”¨æˆ·ç™»å½•" class="headerlink" title="ç”¨æˆ·ç™»å½•"></a>ç”¨æˆ·ç™»å½•</h3><p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG" alt=""></p>
<p>User ğŸ‘‰ å®ä½“ç±»ï¼Œä¸æ•°æ®åº“è¡¨ user å‘å¯¹åº”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥äº† Getter Setter toString æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserDaoã€UserMapperğŸ‘‰ é€šè¿‡ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·ååˆ°æ•°æ®åº“ä¸­æ‰¾åˆ°æ­¤ç”¨æˆ·çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">User <span class="title">getByUsername</span><span class="params">(String username)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getByUsername"</span> <span class="attr">resultType</span>=<span class="string">"com.wingo.model.po.User"</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å…·ä½“çš„sql --&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    	user_id, username, password</span><br><span class="line">    FROM</span><br><span class="line">    	user</span><br><span class="line">    WHERE</span><br><span class="line">    	username = #&#123;username&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SecurityServiceã€SecurityServiceImpl ğŸ‘‰ å®ç°ç™»å½•çš„ä¸šåŠ¡é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">login</span><span class="params">(String username, String password, HttpSession session)</span> </span>&#123;</span><br><span class="line">    User user = userDao.getByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"ä¸å­˜åœ¨è¯¥ç”¨æˆ·å"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!user.getPassword().equals(password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"å¯†ç ä¸æ­£ç¡®"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†å·²ç™»å½•çš„ç”¨æˆ·çš„ userId ä¿å­˜åœ¨ Session ä¸­</span></span><br><span class="line">    session.setAttribute(Constant.USER_TOKEN, user.getUserId());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SecurityController ğŸ‘‰ URLæ˜ å°„ä»¥åŠå‰åç«¯æ•°æ®äº¤äº’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"login"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">login</span><span class="params">(HttpSession session, @RequestParam String username, @RequestParam String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> securityService.login(username, password, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®åï¼Œå‘é€ Ajax è¯·æ±‚è¿›è¡Œç”¨æˆ·éªŒè¯ï¼ŒéªŒè¯é€šè¿‡åè·³è½¬åˆ° chatroom é¡µé¢ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type : <span class="string">'POST'</span>,</span><br><span class="line">        url : <span class="string">'login'</span>,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        data : &#123;</span><br><span class="line">            username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">            password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">false</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="built_in">window</span>.location.href=<span class="string">"chatroom"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯"><a href="#åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯"></a>åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯</h3><p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG" alt=""></p>
<h4 id="ç”¨æˆ·æ‹¦æˆªè®¤è¯"><a href="#ç”¨æˆ·æ‹¦æˆªè®¤è¯" class="headerlink" title="ç”¨æˆ·æ‹¦æˆªè®¤è¯"></a>ç”¨æˆ·æ‹¦æˆªè®¤è¯</h4><p>UserAuthInteceptor ğŸ‘‰ æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•å¹¶è®¾ç½®èµ„æºè®¿é—®æƒé™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAuthInteceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        Object userToken = session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (userToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.sendRedirect(<span class="string">"login"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å…è®¸æ‰€æœ‰èµ„æºéƒ½å¯ä»¥è®¿é—®èµ„æº</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºæ˜¯å¦å¯ä»¥å°†å¯¹è¯·æ±‚çš„å“åº”æš´éœ²ç»™é¡µé¢</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>,<span class="string">"true"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é…ç½® Spring MVC å¯¹ chatoom é¡µé¢çš„è®¿é—®è¯·æ±‚è¿›è¡Œæ‹¦æˆªè®¤è¯</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ç”¨æˆ·è®¤è¯æ‹¦æˆªå™¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/chatroom/**"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.wingo.web.interceptor.UserAuthInteceptor"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="PO-amp-VO"><a href="#PO-amp-VO" class="headerlink" title="PO &amp; VO"></a>PO &amp; VO</h4><p>åœ¨è¿”å›ç»™ç”¨æˆ·çš„ä¿¡æ¯ä¸­ï¼Œé™¤äº†ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œè¿˜éœ€è¦ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ä¿¡æ¯ä»¥åŠç¾¤èŠåˆ—è¡¨ä¿¡æ¯ã€‚åˆ›å»ºä¸€ä¸ª VO ç±»ç”¨äºä¿å­˜å‰ç«¯æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG" alt=""></p>
<p>UserInfo ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; friendList; <span class="comment">// å¥½å‹åˆ—è¡¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Chatgroup&gt; groupList; <span class="comment">// ç¾¤èŠä¿¡æ¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨æ–¹æ³•ä¾¿äºå®ä¾‹åŒ–</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Chatgroup ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// group ä¸º MySQL çš„å…³é”®å­—ï¼Œä¸å¯ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chatgroup</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GroupInfo ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; members;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å™¨æ–¹æ³•ä¾¿äºå®ä¾‹åŒ–</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ChatroomController ğŸ‘‰ é€šè¿‡ userId è·å–ç”¨æˆ·çš„ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/get_userinfo"</span>, method = RequestMethod.POST) </span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">getUserInfo</span><span class="params">(HttpSession session)</span> </span>&#123;</span><br><span class="line">    Object userId = session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">    System.out.println(<span class="string">"Session ä¸­çš„ userId = "</span> + userId);</span><br><span class="line">    <span class="keyword">return</span> userService.getByUserId(String.valueOf(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserChatRelationDao userChatRelationDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GroupDao groupDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">getByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        User user = userDao.getByUserId(userId);</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo(</span><br><span class="line">            user.getUserId(),</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getPassword(),</span><br><span class="line">            user.getAvatarUrl()</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// friendList æ„é€ </span></span><br><span class="line">        List&lt;String&gt; friendsId = userChatRelationDao.getUserFriendsIdByUserId(userId);</span><br><span class="line">        List&lt;User&gt; friends = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String friendId : friendsId)&#123;</span><br><span class="line">            User friend = userDao.getByUserId(friendId);</span><br><span class="line">            friends.add(friend);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// groupList æ„é€ </span></span><br><span class="line">        List&lt;String&gt; groupsId = userChatRelationDao.getGroupsIdByUserId(userId);</span><br><span class="line">        List&lt;Chatgroup&gt; groups = <span class="keyword">new</span> ArrayList&lt;Chatgroup&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupId : groupsId)&#123;</span><br><span class="line">            Chatgroup group = groupDao.getByGroupId(groupId);</span><br><span class="line">            groups.add(group);</span><br><span class="line">        &#125;</span><br><span class="line">        userInfo.setGroupList(groups);</span><br><span class="line">        userInfo.setFriendList(friends);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"userInfo"</span>, userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ Swagger æ¨¡æ‹Ÿè¯·æ±‚å–å¾—è¿”å›çš„ Json æ•°æ®ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"ä¸€åˆ‡æ­£å¸¸"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"userInfo"</span>: &#123;</span><br><span class="line">            <span class="attr">"userId"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"username"</span>: <span class="string">"test1"</span>,</span><br><span class="line">            <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span>,</span><br><span class="line">            <span class="attr">"friendList"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test2"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">4</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test3"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"userId"</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">"username"</span>: <span class="string">"test4"</span>,</span><br><span class="line">                    <span class="attr">"password"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"avatarUrl"</span>: <span class="string">"static/img/avatar/Member001.jpg"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"groupList"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"groupId"</span>: <span class="number">1000</span>,</span><br><span class="line">                    <span class="attr">"groupName"</span>: <span class="string">"Group1"</span>,</span><br><span class="line">                    <span class="attr">"groupAvatarUrl"</span>: <span class="string">"static/img/avatar/Group01.jpg"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ·ä¿¡æ¯åˆå§‹åŒ–å®Œæˆã€‚</p>
<h3 id="é¡µé¢å¸ƒå±€"><a href="#é¡µé¢å¸ƒå±€" class="headerlink" title="é¡µé¢å¸ƒå±€"></a>é¡µé¢å¸ƒå±€</h3><p>ç²—ç•¥ç‰ˆ</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CLayout01.png" alt=""></p>
<h3 id="ç”¨æˆ·å•èŠ"><a href="#ç”¨æˆ·å•èŠ" class="headerlink" title="ç”¨æˆ·å•èŠ"></a>ç”¨æˆ·å•èŠ</h3><p>å‰ç«¯é¡µé¢åœ¨å–å¾—åå°æ‰€è¿”å›çš„ Json ä¿¡æ¯ä¹‹åï¼Œæ ¹æ®ä¿¡æ¯åˆå§‹åŒ–ç”¨æˆ·çš„èŠå¤©é¡µé¢ã€‚</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CUserInfoInit.PNG" alt=""></p>
<blockquote>
<p>æ­¤ç¨‹åºä¸å°†èŠå¤©ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œæ˜¯ä¿å­˜åœ¨å‰ç«¯çš„èŠå¤©é¡µé¢ç”¨ Javascript æ‰€è‡ªå®šä¹‰çš„ä¸€ä¸ªæ•°æ®ç»“æ„é‡Œï¼Œä¸€ä¸ª<code>SentMessageMap(key, new Array())</code>ã€‚ç”¨æˆ·è¿›è¡Œç”¨æˆ·ä¿¡æ¯çš„åˆå§‹åŒ–æ—¶è¦å°†æ­¤ç”¨æˆ·ä¿¡æ¯ä¸­çš„ groupId ä»¥åŠ userId ä½œä¸ºé”®åˆå§‹åŒ–è¿™ä¸ªèŠå¤©ä¿¡æ¯çš„ Mapï¼Œä»¥ä¾¿åé¢è¿›è¡ŒèŠå¤©ä¿¡æ¯çš„ä¿å­˜ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setUserInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type : <span class="string">'POST'</span>,</span><br><span class="line">        url : <span class="string">'chatroom/get_userinfo'</span>,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">true</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"è·å–ç”¨æˆ·ä¿¡æ¯..."</span>);</span><br><span class="line">            <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œç”¨äºä¿å­˜èŠå¤©ä¿¡æ¯è¿›è¡Œå›æ˜¾</span></span><br><span class="line">                sentMessageMap = <span class="keyword">new</span> SentMessageMap();</span><br><span class="line">                <span class="comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">var</span> userInfo = data.data.userInfo;</span><br><span class="line">                userId = userInfo.userId;</span><br><span class="line">                $(<span class="string">"#username"</span>).html(userInfo.username);</span><br><span class="line">                $(<span class="string">"#avatarUrl"</span>).attr(<span class="string">"src"</span>, userInfo.avatarUrl);</span><br><span class="line">                <span class="keyword">var</span> groupListHTML = <span class="string">""</span>;</span><br><span class="line">                <span class="comment">// è·å–ç”¨æˆ·çš„ç¾¤ç»„ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">var</span> groupList = userInfo.groupList;</span><br><span class="line">                <span class="comment">// åˆå§‹åŒ–ç¾¤èŠæ¡†åˆ—è¡¨</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; groupList.length; i++) &#123;</span><br><span class="line">                    <span class="comment">// æ·»åŠ  Key</span></span><br><span class="line">                    sentMessageMap.put(groupList[i].groupId, <span class="keyword">new</span> <span class="built_in">Array</span>());</span><br><span class="line">                    groupListHTML +=</span><br><span class="line">                        <span class="string">'&lt;li&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;div class="liLeft"&gt;&lt;img src="'</span> + groupList[i].groupAvatarUrl + <span class="string">'"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;div class="liRight"&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;span class="hidden-groupId"&gt;'</span> + groupList[i].groupId + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="intername"&gt;'</span> + groupList[i].groupName + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="infor"&gt;&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ·»åŠ ç¾¤èŠæ¡†åˆ—è¡¨</span></span><br><span class="line">                $(<span class="string">'.conLeft ul'</span>).append(groupListHTML);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> friendListHTML = <span class="string">""</span>;</span><br><span class="line">                <span class="comment">// è·å–ç”¨æˆ·å¥½å‹ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">var</span> friendList = userInfo.friendList;</span><br><span class="line">                <span class="comment">// åˆå§‹åŒ–å¥½å‹æ¡†åˆ—è¡¨</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; friendList.length; i++) &#123;</span><br><span class="line">                    <span class="comment">// æ·»åŠ  Key</span></span><br><span class="line">                    sentMessageMap.put(friendList[i].userId, <span class="keyword">new</span> <span class="built_in">Array</span>());</span><br><span class="line">                    friendListHTML +=</span><br><span class="line">                        <span class="string">'&lt;li&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;div class="liLeft"&gt;&lt;img src="'</span> + friendList[i].avatarUrl + <span class="string">'"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;div class="liRight"&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;span class="hidden-userId"&gt;'</span> + friendList[i].userId + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="intername"&gt;'</span> + friendList[i].username + <span class="string">'&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;span class="infor"&gt;&lt;/span&gt;'</span> + </span><br><span class="line">                        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ·»åŠ å¥½å‹åˆ—è¡¨</span></span><br><span class="line">                $(<span class="string">'.conLeft ul'</span>).append(friendListHTML);</span><br><span class="line">                <span class="comment">// ç»‘å®šå¥½å‹æ¡†ç‚¹å‡»äº‹ä»¶ï¼šæ˜¾ç¤ºå³ä¾§æ¶ˆæ¯æ¡†</span></span><br><span class="line">                $(<span class="string">'.conLeft ul li'</span>).on(<span class="string">'click'</span>, friendLiClickEvent);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å•èŠæµç¨‹"><a href="#å•èŠæµç¨‹" class="headerlink" title="å•èŠæµç¨‹"></a>å•èŠæµç¨‹</h4><p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CSingleSend.PNG" alt=""></p>
<h4 id="ç›‘å¬ç»‘å®š"><a href="#ç›‘å¬ç»‘å®š" class="headerlink" title="ç›‘å¬ç»‘å®š"></a>ç›‘å¬ç»‘å®š</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.WebSocket)&#123;  </span><br><span class="line">    <span class="built_in">window</span>.WebSocket = <span class="built_in">window</span>.MozWebSocket;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket)&#123;  </span><br><span class="line">    socket = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3333"</span>);  </span><br><span class="line">    socket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">var</span> json = <span class="built_in">JSON</span>.parse(event.data);    </span><br><span class="line">        <span class="keyword">if</span> (json.status == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> type = json.data.type;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"æ”¶åˆ°ä¸€æ¡æ–°ä¿¡æ¯ï¼Œç±»å‹ä¸ºï¼š"</span> + type);</span><br><span class="line">            <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"REGISTER"</span>:</span><br><span class="line">                    ws.registerReceive();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"SINGLE_SENDING"</span>:</span><br><span class="line">                    ws.singleReceive(json.data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"ä¸æ­£ç¡®çš„ç±»å‹ï¼"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(json.msg);</span><br><span class="line">            <span class="built_in">console</span>.log(json.msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æˆåŠŸ1ç§’åï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ³¨å†Œåˆ°æœåŠ¡å™¨åœ¨çº¿ç”¨æˆ·è¡¨</span></span><br><span class="line">    socket.onopen = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123; </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"WebSocketå·²æˆåŠŸè¿æ¥ï¼"</span>);  </span><br><span class="line">        ws.register();</span><br><span class="line">    &#125;, <span class="number">1000</span>)  </span><br><span class="line"></span><br><span class="line">    socket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;  </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"WebSocketå·²å…³é—­..."</span>);  </span><br><span class="line">    &#125;;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    alert(<span class="string">"æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketï¼"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="WebSocket-å¤„ç†"><a href="#WebSocket-å¤„ç†" class="headerlink" title="WebSocket å¤„ç†"></a>WebSocket å¤„ç†</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = &#123;</span><br><span class="line">    register: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">window</span>.WebSocket) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">"userId"</span> : userId,</span><br><span class="line">                <span class="string">"type"</span> : <span class="string">"REGISTER"</span></span><br><span class="line">            &#125;;</span><br><span class="line">            socket.send(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"Websocketè¿æ¥æ²¡æœ‰å¼€å¯ï¼"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    singleSend: <span class="function"><span class="keyword">function</span>(<span class="params">fromUserId, toUserId, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">window</span>.WebSocket) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">"fromUserId"</span> : fromUserId,</span><br><span class="line">                <span class="string">"toUserId"</span> : toUserId,</span><br><span class="line">                <span class="string">"content"</span> : content,</span><br><span class="line">                <span class="string">"type"</span> : <span class="string">"SINGLE_SENDING"</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// å°†ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯çš„ WebSocketServerhandler è¿›è¡Œå¤„ç†</span></span><br><span class="line">            socket.send(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"Websocketè¿æ¥æ²¡æœ‰å¼€å¯ï¼"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    registerReceive: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"userIdä¸º "</span> + userId + <span class="string">" çš„ç”¨æˆ·ç™»è®°åˆ°åœ¨çº¿ç”¨æˆ·è¡¨æˆåŠŸï¼"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    singleReceive: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–ã€æ„é€ å‚æ•°</span></span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">        <span class="keyword">var</span> content = data.content;</span><br><span class="line">        <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">        <span class="keyword">var</span> $receiveLi;</span><br><span class="line">        <span class="comment">// ä¸ºè®¾ç½®æ¶ˆæ¯æé†’ä»¥åŠè·å–å¤´åƒå–å¾—å…ƒç´ </span></span><br><span class="line">        $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">                fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                    .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">                $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> answer=<span class="string">''</span>;</span><br><span class="line">        answer += <span class="string">'&lt;li&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="answers"&gt;'</span>+ content +<span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¶ˆæ¯æ¡†å¤„ç† æ”¾å…¥æš‚å­˜åŒºï¼Œè‹¥ç”¨æˆ·æ­£å¤„äºä¸æ–°å‘æ¶ˆæ¯ç”¨æˆ·çš„èŠå¤©çª—å£åˆ™å›æ˜¾ï¼ˆåˆ©ç”¨æš‚å­˜åŒºè®¡ç®—é«˜åº¦ï¼‰</span></span><br><span class="line">        processMsgBox.receiveSingleMsg(answer, fromUserId);</span><br><span class="line">        <span class="comment">// å¥½å‹åˆ—è¡¨å¤„ç† 1.è®¾ç½®çº¢è‰²æé†’æ ‡å¿— 2.è®¾ç½®éƒ¨åˆ†æ–°æ¶ˆæ¯æé†’ 3.ç½®é¡¶æ–°æ¶ˆæ¯</span></span><br><span class="line">        processFriendList.receiving(content, $receiveLi);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å‘é€æŒ‰é’®"><a href="#å‘é€æŒ‰é’®" class="headerlink" title="å‘é€æŒ‰é’®"></a>å‘é€æŒ‰é’®</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.sendBtn'</span>).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">'#toUserId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">'#toGroupId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> news = $(<span class="string">'#dope'</span>).val();</span><br><span class="line">    <span class="keyword">if</span> (toUserId == <span class="string">''</span> &amp;&amp; toGroupId == <span class="string">''</span>) &#123;</span><br><span class="line">        alert(<span class="string">"è¯·é€‰æ‹©å¯¹è¯æ–¹"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(news == <span class="string">''</span>)&#123;</span><br><span class="line">        alert(<span class="string">'æ¶ˆæ¯ä¸èƒ½ä¸ºç©º'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">            ws.singleSend(fromUserId, toUserId, news);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç¾¤å‘</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $(<span class="string">'#dope'</span>).val(<span class="string">''</span>);			</span><br><span class="line">        <span class="keyword">var</span> avatarUrl = $(<span class="string">'#avatarUrl'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">        <span class="keyword">var</span> msg = <span class="string">''</span>;</span><br><span class="line">        msg += <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">            <span class="string">'&lt;div class="news"&gt;'</span> + news + <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="nesHead"&gt;&lt;img src="'</span> + avatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¶ˆæ¯æ¡†å¤„ç†ï¼š</span></span><br><span class="line">        processMsgBox.sendMsg(msg, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¥½å‹åˆ—è¡¨å¤„ç†ï¼š</span></span><br><span class="line">        <span class="keyword">var</span> $sendLi = $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>);</span><br><span class="line">        processFriendList.sending(news, $sendLi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="æ¶ˆæ¯æ¡†å¤„ç†"><a href="#æ¶ˆæ¯æ¡†å¤„ç†" class="headerlink" title="æ¶ˆæ¯æ¡†å¤„ç†"></a>æ¶ˆæ¯æ¡†å¤„ç†</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sendMsg: <span class="function"><span class="keyword">function</span>(<span class="params">msg, toUserId, toGroupId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æŠŠå†…å®¹æ·»åŠ åˆ°æ¶ˆæ¯æ¡†</span></span><br><span class="line">    $(<span class="string">'.newsList'</span>).append(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ‰‹åŠ¨è®¡ç®—ã€è°ƒæ•´å›æ˜¾æ¶ˆæ¯çš„å®½åº¦</span></span><br><span class="line">    <span class="keyword">var</span> $newsDiv = $(<span class="string">'.newsList li'</span>).last().children(<span class="string">"div"</span>).first();</span><br><span class="line">    <span class="keyword">var</span> fixWidth = <span class="number">300</span>; <span class="comment">// è‡ªå®šä¹‰çš„æ¶ˆæ¯æ¡†æœ¬èº«çš„æœ€é•¿å®½åº¦</span></span><br><span class="line">    <span class="keyword">var</span> maxWidth = <span class="number">493</span>; <span class="comment">// æ¶ˆæ¯æ¡†æ‰€åœ¨è¡Œ div çš„æ»¡å®½åº¦ï¼ˆä¸åŒ…å«å¤´åƒæ¡†çš„å®½åº¦éƒ¨åˆ†ï¼‰</span></span><br><span class="line">    <span class="keyword">var</span> minMarginLeftWidth = <span class="number">224</span>; <span class="comment">// æŒ‰ç†è¯´åº”è¯¥æ˜¯ maxwidth - fixWidthï¼Œè¿™é‡Œå‡ºç°äº†ç‚¹é—®é¢˜</span></span><br><span class="line">    <span class="keyword">var</span> marginLeftWidth; <span class="comment">// è¦è®¡ç®—æ¶ˆæ¯æ¡†çš„margin-leftå®½åº¦</span></span><br><span class="line">    <span class="keyword">if</span> ($newsDiv.actual(<span class="string">'width'</span>) &lt; fixWidth) &#123;</span><br><span class="line">        marginLeftWidth = maxWidth - $newsDiv.actual(<span class="string">'width'</span>);</span><br><span class="line">        $newsDiv.css(<span class="string">"margin-left"</span>, marginLeftWidth + <span class="string">"px"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $newsDiv.css(<span class="string">"width"</span>, fixWidth + <span class="string">"px"</span>)</span><br><span class="line">            .css(<span class="string">"margin-left"</span>, minMarginLeftWidth + <span class="string">"px"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æŠŠ è°ƒæ•´åçš„æ¶ˆæ¯htmlæ ‡ç­¾å­—ç¬¦ä¸² æ·»åŠ åˆ°å·²å‘é€ç”¨æˆ·æ¶ˆæ¯è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¾—åˆ°æ•°ç»„æ·»åŠ æ–°æ¶ˆæ¯ ä»¥ outerHTML çš„å½¢å¼</span></span><br><span class="line">        <span class="comment">// last() å¾—åˆ°åŒ¹é…å…ƒç´ çš„æœ€åä¸€ä¸ª</span></span><br><span class="line">        sentMessageMap.get(toUserId).push($(<span class="string">'.newsList li'</span>).last().prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentMessageMap.get(toGroupId).push($(<span class="string">'.newsList li'</span>).last().prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. æ»šåŠ¨æ¡å¾€åº•éƒ¨ç§»</span></span><br><span class="line">    $(<span class="string">'.RightCont'</span>).scrollTop($(<span class="string">'.RightCont'</span>)[<span class="number">0</span>].scrollHeight );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¥½å‹åˆ—è¡¨å¤„ç†"><a href="#å¥½å‹åˆ—è¡¨å¤„ç†" class="headerlink" title="å¥½å‹åˆ—è¡¨å¤„ç†"></a>å¥½å‹åˆ—è¡¨å¤„ç†</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sending: <span class="function"><span class="keyword">function</span>(<span class="params">content, $sendLi</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®éƒ¨åˆ†æ–°æ¶ˆæ¯æé†’</span></span><br><span class="line">    <span class="keyword">if</span> (content.length &gt; <span class="number">8</span>) &#123;</span><br><span class="line">        content = content.substring(<span class="number">0</span>, <span class="number">8</span>) + <span class="string">"..."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>).children(<span class="string">'.liRight'</span>).children(<span class="string">'.infor'</span>).text(content);</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨æ–°æ¶ˆæ¯æé†’å¾½ç« ï¼Œåˆ™å»é™¤å¾½ç« </span></span><br><span class="line">    <span class="keyword">if</span> ($sendLi.find(<span class="string">'.layui-badge'</span>).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $sendLi.find(<span class="string">'.layui-badge'</span>).remove();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//$('.conLeft ul').prepend('&lt;li class="bg"&gt;' + $sendLi.html() + '&lt;/li&gt;');</span></span><br><span class="line">    <span class="comment">// å¥½å‹æ¡†æ–°æ¶ˆæ¯ç½®é¡¶</span></span><br><span class="line">    $(<span class="string">'.conLeft ul'</span>).prepend($sendLi.prop(<span class="string">"outerHTML"</span>));</span><br><span class="line">    $sendLi.remove();</span><br><span class="line">    $(<span class="string">'.conLeft ul li'</span>).first().on(<span class="string">'click'</span>, friendLiClickEvent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœåŠ¡å™¨å¤„ç†"><a href="#æœåŠ¡å™¨å¤„ç†" class="headerlink" title="æœåŠ¡å™¨å¤„ç†"></a>æœåŠ¡å™¨å¤„ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">singleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toUserId = (String)param.get(<span class="string">"toUserId"</span>);</span><br><span class="line">    String content = (String)param.get(<span class="string">"content"</span>);</span><br><span class="line">    <span class="comment">// å–å¾—æ¥æ”¶è€…çš„é€šé“</span></span><br><span class="line">    ChannelHandlerContext toUserCtx = Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">"userIdä¸º &#123;0&#125; çš„ç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼"</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"content"</span>, content)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯ç»™æ¥æ”¶è€…çš„é€šé“ï¼Œæµè§ˆå™¨ socket ç›‘å¬å¤„ç†</span></span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest02.PNG" alt=""></p>
<p>é€šè¿‡æ§åˆ¶å°è°ƒè¯•å¯ä»¥å–å¾— sentMessageMap ä¸­ä¿å­˜äº†ä¸ userId=2 çš„ç”¨æˆ·çš„èŠå¤©ä¿¡æ¯æ•°ç»„ã€‚</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest03.PNG" alt=""></p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest01.PNG" alt=""></p>
<p>é€šè¿‡æ§åˆ¶å°è°ƒè¯•å¯ä»¥å–å¾— sentMessageMap ä¸­ä¿å­˜äº†ä¸ userId=1 çš„ç”¨æˆ·çš„èŠå¤©ä¿¡æ¯æ•°ç»„ã€‚</p>
<p><img src="D:%5CImage%5C2020%5C03%5CChatroom%5CTest04.PNG" alt=""></p>
<h3 id="ç¾¤ç»„èŠå¤©"><a href="#ç¾¤ç»„èŠå¤©" class="headerlink" title="ç¾¤ç»„èŠå¤©"></a>ç¾¤ç»„èŠå¤©</h3><p>ç¾¤ç»„èŠå¤©çš„æµç¨‹ä¸ç”¨æˆ·å•èŠæµç¨‹åŸºæœ¬ç›¸ä¼¼ï¼Œåªæ˜¯åœ¨ç»™æ¥æ”¶è€…çš„é€šé“å‘é€æ¶ˆæ¯æ—¶éœ€è¦é€šè¿‡ç¾¤ç»„ä¿¡æ¯å–å¾—ç¾¤ç»„é‡Œçš„æˆå‘˜çš„ä¿¡æ¯ï¼Œå¹¶è·å–æˆå‘˜çš„æ‰€æœ‰é€šé“è¿›è¡Œæ¶ˆæ¯çš„éå‘é€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">groupSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toGroupId = (String)param.get(<span class="string">"toGroupId"</span>);</span><br><span class="line">    String content = (String)param.get(<span class="string">"content"</span>);</span><br><span class="line">    Chatgroup chatgroup = groupDao.getByGroupId(toGroupId);</span><br><span class="line">    <span class="keyword">if</span> (chatgroup == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().error(<span class="string">"è¯¥ç¾¤idä¸å­˜åœ¨"</span>).toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;String&gt; groupUsersId = userChatRelationDao.getUsersIdByGroupId(toGroupId);</span><br><span class="line">        List&lt;User&gt; groupUser = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupUserId : groupUsersId)&#123;</span><br><span class="line">            groupUser.add(userDao.getByUserId(groupUserId));</span><br><span class="line">        &#125;</span><br><span class="line">        GroupInfo groupInfo = <span class="keyword">new</span> GroupInfo(</span><br><span class="line">            chatgroup.getGroupId(),</span><br><span class="line">            chatgroup.getGroupName(),</span><br><span class="line">            chatgroup.getGroupAvatarUrl(),</span><br><span class="line">            groupUser</span><br><span class="line">        );</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"content"</span>, content)</span><br><span class="line">            .setData(<span class="string">"toGroupId"</span>, toGroupId)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.GROUP_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        groupInfo.getMembers()</span><br><span class="line">            .forEach(member -&gt; &#123;</span><br><span class="line">                ChannelHandlerContext toCtx = Constant.onlineUserMap.get(String.valueOf(member.getUserId()));</span><br><span class="line">                <span class="keyword">if</span> (toCtx != <span class="keyword">null</span> &amp;&amp; !String.valueOf(member.getUserId()).equals(fromUserId)) &#123;</span><br><span class="line">                    sendMessage(toCtx, responseJson);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥æ”¶æ¶ˆæ¯è€…åˆ™æ ¹æ® groupId æ¥æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">groupReceive: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ã€æ„é€ å‚æ•°</span></span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">    <span class="keyword">var</span> content = data.content;</span><br><span class="line">    <span class="keyword">var</span> toGroupId = data.toGroupId;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">            <span class="comment">/* $receiveLi = $(this).parent(".liRight").parent("li"); */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-groupId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// ç¾¤ç»„èŠå¤©æ¡†</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == toGroupId) &#123;</span><br><span class="line">            $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> answer=<span class="string">''</span>;</span><br><span class="line">    answer += <span class="string">'&lt;li&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answers"&gt;'</span>+ content +<span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¶ˆæ¯æ¡†å¤„ç†   </span></span><br><span class="line">    processMsgBox.receiveGroupMsg(answer, toGroupId);</span><br><span class="line">    <span class="comment">// å¥½å‹åˆ—è¡¨å¤„ç†</span></span><br><span class="line">    processFriendList.receiving(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="å‘é€è¡¨æƒ…"><a href="#å‘é€è¡¨æƒ…" class="headerlink" title="å‘é€è¡¨æƒ…"></a>å‘é€è¡¨æƒ…</h3><p>è¡¨æƒ…çš„å‘é€çš„åº•å±‚åŸç†å’Œå‘é€æ–‡å­—æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å‘é€è¡¨æƒ…çš„è¯ï¼Œå‘é€å†…å®¹æ˜¯ä¸€ä¸²é™æ€èµ„æºçš„ URIã€‚</p>
<p>è¡¨æƒ…æ¨¡å—ç»‘å®šçš„ç›‘å¬äº‹ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.ExP'</span>).on(<span class="string">'mouseenter'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">'.emjon'</span>).show();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">'.emjon'</span>).on(<span class="string">'mouseleave'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">'.emjon'</span>).hide();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="å‘é€æ–‡ä»¶"><a href="#å‘é€æ–‡ä»¶" class="headerlink" title="å‘é€æ–‡ä»¶"></a>å‘é€æ–‡ä»¶</h3><p>æ–‡ä»¶çš„ä¸Šä¼ ä½¿ç”¨çš„æ˜¯ commons-fileupload å·¥å…·ç±»ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ–‡ä»¶ä¸Šä¼  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ä¸Šä¼ çš„æ¨¡æ€æ¡†è¡¨æ ¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"col-sm-3 control-label"</span>&gt;</span>é€‰æ‹©æ–‡ä»¶<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-9"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">class</span>=<span class="string">"col-sm-9 myfile"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"help-block"</span>&gt;</span>æ³¨æ„ï¼šæ–‡ä»¶å¤§å°ä¸è¶…è¿‡30Mï¼Œæœ‰æ•ˆæœŸä¸º7å¤©<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Bootstrap çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ bootstrap-fileinput çš„ä½¿ç”¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">".myfile"</span>).fileinput(&#123;</span><br><span class="line">    uploadUrl:<span class="string">"chatroom/upload"</span>,</span><br><span class="line">    uploadAsync : <span class="literal">true</span>, <span class="comment">// é»˜è®¤å¼‚æ­¥ä¸Šä¼ </span></span><br><span class="line">    showUpload : <span class="literal">true</span>, <span class="comment">// æ˜¯å¦æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®</span></span><br><span class="line">    showRemove : <span class="literal">false</span>, <span class="comment">// æ˜¾ç¤ºç§»é™¤æŒ‰é’®</span></span><br><span class="line">    showCaption : <span class="literal">false</span>, <span class="comment">// æ˜¯å¦æ˜¾ç¤ºæ ‡é¢˜</span></span><br><span class="line">    showPreview : <span class="literal">true</span>, <span class="comment">// æ˜¯å¦æ˜¾ç¤ºé¢„è§ˆï¼Œé»˜è®¤ä¸º true</span></span><br><span class="line">    dropZoneTitle: <span class="string">"è¯·é€šè¿‡æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶æ”¾åˆ°è¿™é‡Œ"</span>,</span><br><span class="line">    dropZoneEnabled : <span class="literal">false</span>, <span class="comment">// æ˜¯å¦æ˜¾ç¤ºæ‹–æ‹½åŒºåŸŸï¼Œé»˜è®¤ä¸å†™ä¸º trueï¼Œä½†æ˜¯ä¼šå ç”¨å¾ˆå¤§åŒºåŸŸ</span></span><br><span class="line">    maxFileSize: <span class="number">30720</span>, <span class="comment">// å•ä½ä¸º kbï¼Œå¦‚æœä¸º 0 è¡¨ç¤ºä¸é™åˆ¶æ–‡ä»¶å¤§å°</span></span><br><span class="line">    maxFileCount : <span class="number">1</span>,  <span class="comment">// è¡¨ç¤ºå…è®¸åŒæ—¶ä¸Šä¼ çš„æœ€å¤§æ–‡ä»¶ä¸ªæ•°</span></span><br><span class="line">    enctype : <span class="string">'multipart/form-data'</span>,</span><br><span class="line">    validateInitialCount : <span class="literal">true</span>,</span><br><span class="line">    previewFileIcon : <span class="string">"&lt;i class='glyphicon glyphicon-file'&gt;&lt;/i&gt;"</span>,</span><br><span class="line">    msgFilesTooMany : <span class="string">"é€‰æ‹©ä¸Šä¼ çš„æ–‡ä»¶æ•°é‡(&#123;n&#125;) è¶…è¿‡å…è®¸çš„æœ€å¤§æ•°å€¼&#123;m&#125;ï¼"</span>,</span><br><span class="line">    language : <span class="string">'zh'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// å¼‚æ­¥ä¸Šä¼ è¿”å›æ–‡ä»¶ä¸Šä¼ é”™è¯¯ç»“æœå¤„ç†</span></span><br><span class="line">$(<span class="string">'.myfile'</span>).on(<span class="string">'fileerror'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, msg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fileerror"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å¼‚æ­¥ä¸Šä¼ è¿”å›ç»“æœå¤„ç†</span></span><br><span class="line">$(<span class="string">".myfile"</span>).on(<span class="string">"fileuploaded"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. ä¸Šä¼ æˆåŠŸ1.5ç§’åè‡ªåŠ¨å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fileuploaded"</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'#upload-cancel'</span>).trigger(<span class="string">'click'</span>);</span><br><span class="line">        $(<span class="string">'.fileinput-remove'</span>).trigger(<span class="string">'click'</span>);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è·å–ã€è®¾ç½®å‚æ•°</span></span><br><span class="line">    <span class="keyword">var</span> returnData = data.response.data;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = returnData.originalFilename;</span><br><span class="line">    <span class="keyword">var</span> fileSize = returnData.fileSize;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = returnData.fileUrl;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">"[æ–‡ä»¶]"</span>;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> avatarUrl = $(<span class="string">'#avatarUrl'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">    <span class="keyword">var</span> $sendLi = $(<span class="string">'.conLeft'</span>).find(<span class="string">'li.bg'</span>);</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">'#toUserId'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">'#toGroupId'</span>).val();</span><br><span class="line">    <span class="comment">// æ‹¼æ¥å‘é€è€…å¯¹è¯æ¡†çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;div class="send-file-shown"&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;a href="'</span> + fileUrl + <span class="string">'" class="media-left"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;i class="glyphicon glyphicon-file" style="font-size:28pt;"&gt;&lt;/i&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/a&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media-body"&gt; '</span> +</span><br><span class="line">        <span class="string">'&lt;h5 class="media-heading"&gt;'</span> + originalFilename + <span class="string">'&lt;/h5&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;span&gt;'</span>+ fileSize + <span class="string">'&lt;/span&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="nesHead"&gt;&lt;img src="'</span> + avatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. å‘é€ä¿¡æ¯åˆ°æœåŠ¡å™¨        </span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.length != <span class="number">0</span>) &#123;</span><br><span class="line">        ws.fileMsgSingleSend(fromUserId, toUserId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ws.fileMsgGroupSend(fromUserId, toGroupId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. æ¶ˆæ¯æ¡†å¤„ç†ï¼š </span></span><br><span class="line">    processMsgBox.sendFileMsg(fileHtml, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. å¥½å‹åˆ—è¡¨å¤„ç†</span></span><br><span class="line">    processFriendList.sending(content, $sendLi);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸Šä¼ å‰</span></span><br><span class="line">$(<span class="string">'.myfile'</span>).on(<span class="string">'filepreupload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"filepreupload"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ä¸Šä¼ çš„æ§åˆ¶å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/upload"</span>, method = POST)</span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseJson <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestParam(value = <span class="string">"file"</span>, required = <span class="keyword">true</span>)</span> MultipartFile file, HttpServletRequest request) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fileUploadService.upload(file, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ä¸Šä¼ çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadServiceImpl</span> <span class="keyword">implements</span> <span class="title">FileUploadService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¡¹ç›®çš„æ‰“åŒ…ç›®å½•ï¼Œæœ¬é¡¹ç›®æ‰“åŒ…åœ¨æ ¹ç›®å½•ä¸‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String SERVER_URL_PREFIX = <span class="string">"http://localhost:8080/"</span>;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¸Šä¼ æ–‡ä»¶çš„æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FILE_STORE_PATH = <span class="string">"UploadFile"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseJson <span class="title">upload</span><span class="params">(MultipartFile file, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é‡å‘½åæ–‡ä»¶ï¼Œé˜²æ­¢é‡å</span></span><br><span class="line">        String filename = getRandomUUID();</span><br><span class="line">        String suffix = <span class="string">""</span>;</span><br><span class="line">        String originalFilename = file.getOriginalFilename();</span><br><span class="line">        String fileSize = FileUtils.getFormatSize(file.getSize());</span><br><span class="line">        <span class="comment">// æˆªå–æ–‡ä»¶çš„åç¼€å</span></span><br><span class="line">        <span class="keyword">if</span> (originalFilename.contains(<span class="string">"."</span>)) &#123;</span><br><span class="line">            suffix = originalFilename.substring(originalFilename.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        filename = filename + suffix;</span><br><span class="line">        <span class="comment">// getRealPath(â€œ/â€) è·å–å®é™…è·¯å¾„,â€œ/â€æŒ‡ä»£é¡¹ç›®æ ¹ç›®å½•,æ‰€ä»¥ä»£ç è¿”å›çš„æ˜¯é¡¹ç›®åœ¨å®¹å™¨ä¸­çš„å®é™…å‘å¸ƒè¿è¡Œçš„æ ¹è·¯å¾„</span></span><br><span class="line">        String prefix = request.getSession().getServletContext().getRealPath(<span class="string">"/"</span>) + FILE_STORE_PATH;</span><br><span class="line">        System.out.println(<span class="string">"å­˜å‚¨è·¯å¾„ä¸º:"</span> + prefix + <span class="string">"\\"</span> + filename);</span><br><span class="line">        Path filePath = Paths.get(prefix, filename);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.copy(file.getInputStream(), filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().error(<span class="string">"æ–‡ä»¶ä¸Šä¼ å‘ç”Ÿé”™è¯¯ï¼"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"originalFilename"</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">"fileSize"</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">"fileUrl"</span>, SERVER_URL_PREFIX + FILE_STORE_PATH + <span class="string">"\\"</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getRandomUUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSoclet å¤„ç†æ–‡ä»¶å‘é€æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FileMsgSingleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    String fromUserId = String.valueOf(param.get(<span class="string">"fromUserId"</span>));</span><br><span class="line">    String toUserId = (String)param.get(<span class="string">"toUserId"</span>);</span><br><span class="line">    String originalFilename = (String)param.get(<span class="string">"originalFilename"</span>);</span><br><span class="line">    String fileSize = (String)param.get(<span class="string">"fileSize"</span>);</span><br><span class="line">    String fileUrl = (String)param.get(<span class="string">"fileUrl"</span>);</span><br><span class="line">    ChannelHandlerContext toUserCtx = Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">"userIdä¸º &#123;0&#125; çš„ç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼"</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String responseJson = <span class="keyword">new</span> ResponseJson().success()</span><br><span class="line">            .setData(<span class="string">"fromUserId"</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">"originalFilename"</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">"fileSize"</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">"fileUrl"</span>, fileUrl)</span><br><span class="line">            .setData(<span class="string">"type"</span>, ChatType.FILE_MSG_SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç¾¤å‘æ–‡ä»¶åˆ™ä¸ç¾¤ç»„èŠå¤©ç±»ä¼¼ï¼Œå–ç¾¤ç»„ä¸­çš„ç”¨æˆ·çš„é€šé“éå†å‘é€æ–‡ä»¶ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>

<p>æ¥æ”¶è€…å¯¹è¯æ¡†æ¥æ”¶æ–‡ä»¶æ¶ˆæ¯çš„æ‹¼æ¥ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">fileMsgSingleRecieve: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ã€æ„é€ å‚æ•°</span></span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.fromUserId;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = data.originalFilename;</span><br><span class="line">    <span class="keyword">var</span> fileSize = data.fileSize;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = data.fileUrl;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">"[æ–‡ä»¶]"</span>;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">'.conLeft'</span>).find(<span class="string">'span.hidden-userId'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.innerHTML == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>)</span><br><span class="line">                .siblings(<span class="string">".liLeft"</span>).children(<span class="string">'img'</span>).attr(<span class="string">"src"</span>);</span><br><span class="line">            $receiveLi = $(<span class="keyword">this</span>).parent(<span class="string">".liRight"</span>).parent(<span class="string">"li"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">'&lt;li&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;div class="receive-file-shown"&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;div class="media"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="media-body"&gt; '</span> +</span><br><span class="line">        <span class="string">'&lt;h5 class="media-heading"&gt;'</span> + originalFilename + <span class="string">'&lt;/h5&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;span&gt;'</span>+ fileSize + <span class="string">'&lt;/span&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;a href="'</span> + fileUrl + <span class="string">'" class="media-right"&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;i class="glyphicon glyphicon-file" style="font-size:28pt;"&gt;&lt;/i&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/a&gt;'</span> + </span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span>+</span><br><span class="line">        <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;div class="answerHead"&gt;&lt;img src="'</span> + fromAvatarUrl + <span class="string">'"/&gt;&lt;/div&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¶ˆæ¯æ¡†å¤„ç†     </span></span><br><span class="line">    processMsgBox.receiveSingleMsg(fileHtml, fromUserId);</span><br><span class="line">    <span class="comment">// å¥½å‹åˆ—è¡¨å¤„ç†</span></span><br><span class="line">    processFriendList.receiving(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>


        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2020-04-19T06:24:52.203Z" itemprop="dateUpdated">2020-04-19 14:24:52</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/avatar.jpg" alt="Wingo">
            Wingo
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chatroom/" rel="tag">Chatroom</a></li></ul>


            


        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/02/25/English/CET6%20%E9%98%85%E8%AF%BB%E7%9C%9F%E9%A2%98/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">CET6 é˜…è¯»çœŸé¢˜</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/02/22/Chatroom/Chatroom%20Mybatis/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Chatroom Mybatis</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
            <span>å¾—å¤±ä»ç¼˜ï¼Œå¿ƒæ— å¢å‡</span>
        </p>
    </div> 
    <div class="bottom">
        <p><span>Wingo &copy; 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: false, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










</body>
</html>
